name: Seed Problem(s) and Upload Images

on:
  push:
    paths:
      - 'python/problems/**'
      - 'python/images/**'
    branches:
      - main  

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      problem_files_added: ${{ steps.set-env.outputs.problem_files_added }}
      image_files_added: ${{ steps.set-env.outputs.image_files_added }}
      problem_files_paths: ${{ steps.set-env.outputs.problem_files_paths }}
      image_files_paths: ${{ steps.set-env.outputs.image_files_paths }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect Added Files
        id: set-env
        run: |
          echo "ðŸ“¥ Fetching added files in the current repository..."
          ADDED_FILES=$(git diff --name-only --diff-filter=ACMR ${{ github.event.before }} ${{ github.event.after }})
          echo "$ADDED_FILES"

          # Check for problem files
          PROBLEM_FILES=$(echo "$ADDED_FILES" | grep "^python/problems/" || true)
          if [ -n "$PROBLEM_FILES" ]; then
            echo "problem_files_added=true" >> $GITHUB_OUTPUT
            echo "problem_files_paths=$(echo $PROBLEM_FILES | paste -sd "," -)" >> $GITHUB_OUTPUT
          fi

          # Check for image files
          IMAGE_FILES=$(echo "$ADDED_FILES" | grep "^python/images/" || true)
          if [ -n "$IMAGE_FILES" ]; then
            echo "image_files_added=true" >> $GITHUB_OUTPUT
            echo "image_files_paths=$(echo $IMAGE_FILES | paste -sd "," -)" >> $GITHUB_OUTPUT
          fi

  seed_problems:
    needs: detect_changes
    if: needs.detect_changes.outputs.problem_files_added == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codescript-backend
        uses: actions/checkout@v4
        with:
          repository: jjpark987/codescript-backend
          ref: fastapi
          path: ./codescript-fastapi
          fetch-depth: 1

      - name: Checkout codescript-problems
        uses: actions/checkout@v4
        with:
          repository: jjpark987/codescript-problems
          path: ./codescript-problems
          fetch-depth: 1

      - name: Ensure Docker Network Exists
        run: |
          docker network inspect codescript_network >/dev/null 2>&1 || \
          docker network create codescript_network

      - name: Run codescript-fastapi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        run: |
          echo "ðŸ“„ Added problem files:"
          echo "${{ needs.detect_changes.outputs.problem_files_paths }}"
          
          echo "ðŸš€ Deploying codescript-fastapi..."
          cd codescript-fastapi
          docker compose up -d
          echo "âœ… API docker is running!"

      - name: Run codescript-problems
        env:
          PROBLEM_FILES_PATHS: ${{ env.problem_files_paths }}
          IMAGE_FILES_PATHS: ${{ env.image_files_paths }}
        run: |
          echo "ðŸš€ Deploying codescript-problems..."
          cd codescript-problems
          docker compose up --remove-orphans
          echo "âœ… Problems docker has completed the script!"

      - name: Clean up codescript-fastapi
        run: |
          echo "ðŸ§¹ Cleaning up codescript-fastapi..."
          cd codescript-fastapi
          docker compose down --remove-orphans
          echo "âœ… Completed clean up!"

  upload_images:
    needs: detect_changes
    if: needs.detect_changes.outputs.image_files_added == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Upload images to Google Cloud Storage
        run: |
          echo "Uploading images to Google Cloud Storage..."
          echo "${{ needs.detect_changes.outputs.image_files_paths }}"

          # # Install gcloud CLI
          # sudo apt-get update && sudo apt-get install -y google-cloud-sdk
          # echo "${{ secrets.GCP_CREDENTIALS }}" > $HOME/gcp-credentials.json

          # # Authenticate with Google Cloud
          # gcloud auth activate-service-account --key-file=$HOME/gcp-credentials.json
          # gcloud config set project YOUR_PROJECT_ID

          # # Upload images
          # IFS=',' read -ra FILES <<< "${{ needs.detect_changes.outputs.image_files_paths }}"
          # for file in "${FILES[@]}"; do
          #   gsutil cp "$file" gs://YOUR_BUCKET_NAME/images/
          # done